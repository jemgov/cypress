pipeline {
  agent any

  tools {
    nodejs "NodeJS 25"
  }

  parameters {
    string(
      name: 'TEST_SPEC',
      defaultValue: 'cypress/e2e/**/*.cy.js',
      description: 'Ruta del test o tests a ejecutar'
    )
  }

  stages {

    stage('Instalar dependencias') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Instalando dependencias ==="
              npm ci
              Write-Host "=== Dependencias instaladas ==="
            '''
          }
        }
      }
    }

    stage('Ejecutar pruebas Cypress') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            // Nunca falla el stage aunque Cypress devuelva código distinto de 0
            catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
              powershell '''
                Write-Host "=== Ejecutando pruebas Cypress ==="
                npx cypress run --spec "$env:TEST_SPEC"

                $code = $LASTEXITCODE
                Write-Host "Cypress terminó con código: $code"

                exit 0
              '''
            }
          }
        }
      }
    }

    stage('Generar reporte Mochawesome') {
      steps {
        dir('mi-proyecto-cypress') {
          // Si algo peta aquí, marcamos la stage como FAILURE pero el build como UNSTABLE
          catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
            powershell '''
              Write-Host "=== Generando reporte Mochawesome ==="

              if (Test-Path "cypress/report/.jsons") {
                Write-Host "JSONs encontrados. Generando HTML..."

                npx mochawesome-merge "cypress/report/.jsons/*.json" > "cypress/report/mochawesome.json"

                # OJO: forzamos nombre index.html
                npx marge "cypress/report/mochawesome.json" --reportDir "cypress/report" --reportFilename "index"

                Write-Host "Reporte Mochawesome generado correctamente en cypress/report/index.html"
              } else {
                Write-Host "No hay JSONs de Mochawesome. No se generará HTML."
              }
            '''
          }
        }
      }
    }

    stage('Preparar historial Allure') {
      steps {
        dir('mi-proyecto-cypress') {
          catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
            powershell '''
              Write-Host "=== Copiando historial de Allure (si existe) ==="

              if (Test-Path "allure-report/history") {
                Write-Host "Historial encontrado. Copiando..."
                Copy-Item -Recurse -Force "allure-report/history" "allure-results/history"
              } else {
                Write-Host "No existe historial previo."
              }
            '''
          }
        }
      }
    }

    stage('Diagnóstico de artefactos') {
      steps {
        dir('mi-proyecto-cypress') {
          catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
            powershell '''
              Write-Host "=== Diagnóstico de artefactos ==="

              Write-Host "--- Videos Backup ---"
              Get-ChildItem -Recurse videos_backup -ErrorAction SilentlyContinue

              Write-Host "--- Screenshots Backup ---"
              Get-ChildItem -Recurse screenshots_backup -ErrorAction SilentlyContinue

              Write-Host "--- Mochawesome Report ---"
              Get-ChildItem -Recurse cypress/report -ErrorAction SilentlyContinue

              Write-Host "--- Allure Results ---"
              Get-ChildItem -Recurse allure-results -ErrorAction SilentlyContinue

              Write-Host "--- Allure Report (HTML) ---"
              Get-ChildItem -Recurse allure-report -ErrorAction SilentlyContinue
            '''
          }
        }
      }
    }

    stage('Publicar Mochawesome') {
      steps {
        publishHTML(target: [
          reportDir: 'mi-proyecto-cypress/cypress/report',
          reportFiles: 'index.html',          // ahora sí existe
          reportName: 'Reporte Mochawesome',
          keepAll: true,
          alwaysLinkToLastBuild: true,
          allowMissing: true
        ])
      }
    }
  }

  post {
    always {
      echo '=== Archivando artefactos ==='

      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/report/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/videos_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/screenshots_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-results/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-report/**', allowEmptyArchive: true

      powershell '''
        Write-Host "=== XMLs detectados antes de JUnit ==="
        Get-ChildItem -Recurse "mi-proyecto-cypress/cypress/results/*.xml" -ErrorAction SilentlyContinue
      '''

      // Si JUnit ve tests fallados, que marque UNSTABLE, no FAILURE
      catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
        junit testResults: 'mi-proyecto-cypress/cypress/results/*.xml', allowEmptyResults: true, keepLongStdio: true
      }

      // Forzamos resultado final a UNSTABLE siempre
      script {
        currentBuild.result = 'UNSTABLE'
      }

      allure includeProperties: false, jdk: '', results: [[path: 'mi-proyecto-cypress/allure-results']]
    }
  }
}
