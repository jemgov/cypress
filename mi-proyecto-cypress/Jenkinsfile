pipeline {
  agent any

  tools {
    nodejs "NodeJS 25"
  }

  parameters {
    string(
      name: 'TEST_SPEC',
      defaultValue: 'cypress/e2e/**/*.cy.js',
      description: 'Ruta del test o tests a ejecutar'
    )
  }

  stages {

    stage('Instalar dependencias') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Instalando dependencias ==="
              npm ci

              Write-Host "=== Instalando reporter JUnit seguro ==="
              npm install --save-dev cypress-junit-reporter

              Write-Host "=== Dependencias instaladas ==="
            '''
          }
        }
      }
    }

    stage('Ejecutar pruebas Cypress') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Ejecutando pruebas Cypress ==="

              # Mochawesome como siempre
              # JUnit seguro sin romper XML
              npx cypress run --spec "$env:TEST_SPEC" `
                --reporter mochawesome `
                --reporter-options "reportDir=cypress/report,overwrite=false,html=true,json=true" `
                --reporter cypress-junit-reporter `
                --reporter-options "mochaFile=cypress/results/results-[hash].xml"

              Write-Host "=== Cypress finalizado ==="
            '''
          }
        }
      }
    }

    stage('Preparar historial Allure') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            if (Test-Path "allure-report/history") {
              Copy-Item -Recurse -Force "allure-report/history" "allure-results/history"
            }
          '''
        }
      }
    }

    stage('Backup de videos y screenshots por fecha') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            $dateFolder = (Get-Date -Format "yyyy-MM-dd")

            if (!(Test-Path "videos_backup")) { New-Item -ItemType Directory -Path "videos_backup" | Out-Null }
            if (!(Test-Path "screenshots_backup")) { New-Item -ItemType Directory -Path "screenshots_backup" | Out-Null }

            $videosDatePath = Join-Path "videos_backup" $dateFolder
            $screensDatePath = Join-Path "screenshots_backup" $dateFolder

            if (!(Test-Path $videosDatePath)) { New-Item -ItemType Directory -Path $videosDatePath | Out-Null }
            if (!(Test-Path $screensDatePath)) { New-Item -ItemType Directory -Path $screensDatePath | Out-Null }

            Write-Host "=== Copiando SOLO videos raíz ==="
            Get-ChildItem "cypress/videos" -File -Include *.mp4 -ErrorAction SilentlyContinue |
              ForEach-Object {
                Copy-Item $_.FullName -Destination (Join-Path $videosDatePath $_.Name) -Force
              }

            Write-Host "=== Copiando screenshots ==="
            Get-ChildItem -Recurse "cypress/screenshots" -Include *.png -ErrorAction SilentlyContinue |
              ForEach-Object {
                Copy-Item $_.FullName -Destination (Join-Path $screensDatePath $_.Name) -Force
              }
          '''
        }
      }
    }

    stage('Diagnóstico de artefactos') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "--- Videos Backup ---"
            Get-ChildItem -Recurse videos_backup -ErrorAction SilentlyContinue

            Write-Host "--- Screenshots Backup ---"
            Get-ChildItem -Recurse screenshots_backup -ErrorAction SilentlyContinue

            Write-Host "--- Mochawesome Report ---"
            Get-ChildItem -Recurse cypress/report -ErrorAction SilentlyContinue
          '''
        }
      }
    }

    stage('Publicar Mochawesome') {
      steps {
        publishHTML(target: [
          reportDir: 'mi-proyecto-cypress/cypress/report',
          reportFiles: 'index.html',
          reportName: 'Reporte Mochawesome',
          keepAll: true,
          alwaysLinkToLastBuild: true,
          allowMissing: true
        ])
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/report/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/videos_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/screenshots_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-results/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-report/**', allowEmptyArchive: true

      junit testResults: 'mi-proyecto-cypress/cypress/results/*.xml', allowEmptyResults: true, keepLongStdio: true

      allure includeProperties: false, jdk: '', results: [[path: 'mi-proyecto-cypress/allure-results']]
    }
  }
}
