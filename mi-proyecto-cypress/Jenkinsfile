pipeline {
  agent any

  parameters {
    string(
      name: 'TEST_SPEC',
      defaultValue: 'cypress/e2e/**/*.cy.js',
      description: 'Ruta del test a ejecutar'
    )
  }

  tools {
    nodejs 'NodeJS 25'   // ‚Üê Nombre correcto de tu instalaci√≥n
  }

  environment {
    CYPRESS_CACHE_FOLDER = "${WORKSPACE}/.cache"
  }

  stages {

    stage('Instalar dependencias') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            echo "=== Iniciando instalaci√≥n de dependencias ==="
            npm install
            echo "=== npm install finalizado ==="
          '''
        }
      }
    }

    stage('Ejecutar pruebas') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            echo "=== Ejecutando pruebas Cypress ==="
            npx cypress run --spec "$env:TEST_SPEC"
            echo "=== Cypress finalizado ==="
          '''
        }
      }
    }

    stage('Generar reporte') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            echo "=== Generando reporte HTML ==="

            # Fusionar JSON de mochawesome
            if (Test-Path "cypress/report/.jsons/*.json") {
              npx mochawesome-merge cypress/report/.jsons/*.json > cypress/report/mochawesome.json
              npx marge cypress/report/mochawesome.json --reportDir cypress/report/html
            }
            else {
              echo "‚ö†Ô∏è No se encontraron archivos JSON para fusionar."
            }
          '''
        }
      }
    }
  }

  post {
    always {

      // üì¶ Archivar artefactos (v√≠deos, screenshots, JSON, HTML‚Ä¶)
      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/report/**/*.*', allowEmptyArchive: true

      // üìä Publicar reporte HTML (par√°metros obligatorios incluidos)
      publishHTML([
        reportDir: 'mi-proyecto-cypress/cypress/report/html',
        reportFiles: 'mochawesome.html',
        reportName: 'Reporte Cypress',
        allowMissing: false,
        keepAll: true,
        alwaysLinkToLastBuild: true
      ])

      // üìà Publicar resultados JUnit (XML)
      junit 'mi-proyecto-cypress/cypress/results/*.xml'
    }
  }
}
