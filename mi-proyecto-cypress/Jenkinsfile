pipeline {
  agent any

  tools {
    nodejs "NodeJS 25"
  }

  parameters {
    string(
      name: 'TEST_SPEC',
      defaultValue: 'cypress/e2e/**/*.cy.js',
      description: 'Ruta del test o tests a ejecutar'
    )
  }

  stages {

    stage('Instalar dependencias') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Instalando dependencias ==="
              npm ci
              Write-Host "=== Dependencias instaladas ==="
            '''
          }
        }
      }
    }

    stage('Ejecutar pruebas Cypress') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Ejecutando pruebas Cypress ==="
              npx cypress run --spec "$env:TEST_SPEC"
              Write-Host "=== Pruebas finalizadas ==="
            '''
          }
        }
      }
    }

    stage('Preparar historial Allure') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Copiando historial de Allure (si existe) ==="

            if (Test-Path "allure-report/history") {
              Write-Host "Historial encontrado. Copiando..."
              Copy-Item -Recurse -Force "allure-report/history" "allure-results/history"
            } else {
              Write-Host "No existe historial previo."
            }
          '''
        }
      }
    }

    stage('Generar reporte Allure') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Generando reporte Allure ==="
            allure generate allure-results --clean -o allure-report
            Write-Host "=== Reporte Allure generado ==="
          '''
        }
      }
    }

    stage('Personalizar estilos Allure') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Personalizando colores de status y severidad ==="

            $cssPath = "allure-report\\styles.css"

            if (Test-Path $cssPath) {

              Write-Host "Aplicando estilos personalizados..."

              Add-Content -Path $cssPath -Value @"
/* Colores de status en gráficas circulares y de barras */
path[stroke='#4caf50'] { stroke: #2ecc71 !important; } /* passed */
path[stroke='#f44336'] { stroke: #e74c3c !important; } /* failed */
path[stroke='#ff9800'] { stroke: #e67e22 !important; } /* broken */
path[stroke='#9c27b0'] { stroke: #9b59b6 !important; } /* unknown */
path[stroke='#607d8b'] { stroke: #95a5a6 !important; } /* skipped */

/* Colores de badges de severidad */
.severity-blocker  { background-color: #e74c3c !important; }
.severity-critical { background-color: #e67e22 !important; }
.severity-normal   { background-color: #f1c40f !important; }
.severity-minor    { background-color: #3498db !important; }
.severity-trivial  { background-color: #95a5a6 !important; }
"@

              Write-Host "=== Estilos personalizados aplicados ==="
            } else {
              Write-Host "⚠️ No se encontró styles.css"
            }
          '''
        }
      }
    }

    stage('Diagnóstico de artefactos') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Diagnóstico de artefactos ==="

            Write-Host "--- Videos Backup ---"
            Get-ChildItem -Recurse videos_backup -ErrorAction SilentlyContinue

            Write-Host "--- Screenshots Backup ---"
            Get-ChildItem -Recurse screenshots_backup -ErrorAction SilentlyContinue

            Write-Host "--- Mochawesome Report ---"
            Get-ChildItem -Recurse cypress/report -ErrorAction SilentlyContinue

            Write-Host "--- Allure Results ---"
            Get-ChildItem -Recurse allure-results -ErrorAction SilentlyContinue

            Write-Host "--- Allure Report (HTML) ---"
            Get-ChildItem -Recurse allure-report -ErrorAction SilentlyContinue
          '''
        }
      }
    }
  }

  post {
    always {
      echo '=== Archivando artefactos ==='

      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/report/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/videos_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/screenshots_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-results/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-report/**', allowEmptyArchive: true

      allure includeProperties: false, jdk: '', results: [[path: 'mi-proyecto-cypress/allure-results']]
    }
  }
}
