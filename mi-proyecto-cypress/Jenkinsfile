pipeline {
  agent any

  tools {
    nodejs "NodeJS 25"
  }

  parameters {
    string(
      name: 'TEST_SPEC',
      defaultValue: 'cypress/e2e/**/*.cy.js',
      description: 'Ruta del test o tests a ejecutar'
    )
  }

  stages {

    stage('Limpiar workspace') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Remove-Item -Recurse -Force "cypress/report" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -Force "cypress/mochawesome-html" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -Force "cypress/screenshots" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -Force "cypress/videos" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -Force "cypress/results" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -Force "videos_backup" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -Force "screenshots_backup" -ErrorAction SilentlyContinue

            # ðŸ”¥ FIX DEFINITIVO: crear carpeta JSON antes de Cypress
            New-Item -ItemType Directory -Force -Path "cypress/report/json" | Out-Null
          '''
        }
      }
    }

    stage('Instalar dependencias') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell 'npm ci'
        }
      }
    }

    stage('Ejecutar pruebas Cypress') {
      steps {
        dir('mi-proyecto-cypress') {
          catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
            powershell '''
              npx cypress run --spec "$env:TEST_SPEC"

              if (Test-Path "cypress/videos") {
                Copy-Item -Recurse -Force "cypress/videos" "videos_backup"
              }

              if (Test-Path "cypress/screenshots") {
                Copy-Item -Recurse -Force "cypress/screenshots" "screenshots_backup"
              }
            '''
          }
        }
      }
    }

    stage('Generar reporte Mochawesome') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            if (Test-Path "cypress/report/json") {
              $jsons = Get-ChildItem "cypress/report/json" -Filter *.json
              if ($jsons.Count -gt 0) {
                npx mochawesome-merge "cypress/report/json/*.json" > "cypress/report/mochawesome.json"
                npx marge "cypress/report/mochawesome.json" --reportDir "cypress/mochawesome-html" --reportFilename "index"
              }
            }
          '''
        }
      }
    }

    stage('Publicar Mochawesome') {
      steps {
        publishHTML(target: [
          reportDir: 'mi-proyecto-cypress/cypress/mochawesome-html',
          reportFiles: 'index.html',
          reportName: 'Reporte Mochawesome',
          keepAll: true,
          alwaysLinkToLastBuild: true,
          allowMissing: true
        ])
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/report/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/mochawesome-html/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/videos_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/screenshots_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-results/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-report/**', allowEmptyArchive: true

      junit testResults: 'mi-proyecto-cypress/cypress/results/*.xml', allowEmptyResults: true, keepLongStdio: true

      script {
        currentBuild.result = 'UNSTABLE'
      }

      allure includeProperties: false, jdk: '', results: [[path: 'mi-proyecto-cypress/allure-results']]
    }
  }
}
