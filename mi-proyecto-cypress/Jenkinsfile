pipeline {
  agent any

  parameters {
    string(
      name: 'TEST_SPEC',
      defaultValue: 'cypress/e2e/**/*.cy.js',
      description: 'Ruta del test a ejecutar'
    )
  }

  tools {
    nodejs 'NodeJS 25'
  }

  environment {
    CYPRESS_CACHE_FOLDER = "${WORKSPACE}/.cache"
  }

  stages {

    stage('Instalar dependencias') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            echo "=== Instalando dependencias ==="
            npm install

            echo "=== Instalando binario de Cypress ==="
            npx cypress install
          '''
        }
      }
    }

    stage('Ejecutar pruebas Cypress') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell """
            echo '=== Ejecutando pruebas Cypress ==='
            echo 'TEST_SPEC = ${params.TEST_SPEC}'
            npx cypress run --spec \"${params.TEST_SPEC}\"
          """
        }
      }
    }
  }

  post {
    always {
      dir('mi-proyecto-cypress') {
        powershell '''
          echo "=== Verificando JSONs ==="
          if (!(Test-Path "cypress/report/.jsons")) {
            echo "No existe la carpeta .jsons"
            exit 0
          }

          $jsonFiles = Get-ChildItem "cypress/report/.jsons" -Filter *.json
          if ($jsonFiles.Count -eq 0) {
            echo "No hay JSONs para fusionar. Saltando marge."
            exit 0
          }

          echo "=== Fusionando JSONs con mochawesome-merge ==="
          npx mochawesome-merge cypress/report/.jsons/*.json -o cypress/report/mochawesome.json

          echo "=== Verificando mochawesome.json ==="
          if (!(Test-Path "cypress/report/mochawesome.json")) {
            echo "No se gener√≥ mochawesome.json"
            exit 1
          }

          echo "=== Generando HTML con marge ==="
          if (!(Test-Path "cypress/report/html")) {
            New-Item -ItemType Directory -Force -Path "cypress/report/html" | Out-Null
          }

          npx marge cypress/report/mochawesome.json --reportDir cypress/report/html --reportFilename mochawesome.html --inline --overwrite

          echo "=== Verificando HTML generado ==="
          Get-ChildItem "cypress/report/html"
        '''
      }

      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/report/**/*.*', allowEmptyArchive: true

      publishHTML([
        reportDir: 'mi-proyecto-cypress/cypress/report/html',
        reportFiles: 'mochawesome.html',
        reportName: 'Reporte Cypress (Mochawesome)',
        keepAll: true,
        alwaysLinkToLastBuild: true,
        allowMissing: true
      ])

      junit 'mi-proyecto-cypress/cypress/results/*.xml'
    }
  }
}
