pipeline {
  agent any

  tools {
    nodejs "NodeJS 25"
  }

  parameters {
    string(
      name: 'TEST_SPEC',
      defaultValue: 'e2e/1-getting-started/PRUEBAS/*.cy.js',
      description: 'Ruta del test o tests a ejecutar'
    )
  }

  stages {

    stage('Instalar dependencias') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Instalando dependencias ==="
              npm ci
              Write-Host "=== Dependencias instaladas ==="
            '''
          }
        }
      }
    }

    stage('Ejecutar pruebas Cypress') {
      steps {
        timeout(time: 10, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Ejecutando pruebas Cypress ==="
              npx cypress run --spec "$env:TEST_SPEC"
              Write-Host "=== Pruebas finalizadas ==="
            '''
          }
        }
      }
    }

    stage('Diagnóstico de artefactos') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Diagnóstico de artefactos ==="

            Write-Host "--- Videos ---"
            Get-ChildItem -Recurse cypress/report/videos -ErrorAction SilentlyContinue

            Write-Host "--- Screenshots ---"
            Get-ChildItem -Recurse cypress/report/screenshots -ErrorAction SilentlyContinue

            Write-Host "--- Backups de videos ---"
            Get-ChildItem -Recurse videos_backup -ErrorAction SilentlyContinue

            Write-Host "--- Backups de screenshots ---"
            Get-ChildItem -Recurse screenshots_backup -ErrorAction SilentlyContinue
          '''
        }
      }
    }

    stage('Generar reporte Mochawesome') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Generando reporte HTML ==="

            try {
              $jsonFiles = Get-ChildItem -Path cypress/report -Filter *.json
              if ($jsonFiles.Count -eq 0) {
                Write-Host "⚠️ No hay JSON para fusionar. Se omite el reporte."
                exit 0
              }

              $json = npx mochawesome-merge cypress/report/*.json
              if (-not $json -or $json.Contains('"results": []')) {
                Write-Host "⚠️ JSON vacío. No se genera HTML."
                exit 0
              }

              $json | Set-Content -Encoding utf8NoBOM mochawesome.json
              npx marge mochawesome.json --reportDir cypress/report --inline
              Write-Host "✅ Reporte generado en cypress/report/index.html"
            } catch {
              Write-Host "⚠️ Error generando el reporte, pero no se detiene el pipeline."
            }

            exit 0
          '''
        }
      }
    }
  }

  post {
    always {
      echo '=== Archivando artefactos ==='

      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/report/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/videos_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/screenshots_backup/**', allowEmptyArchive: true

      publishHTML([
        reportDir: 'mi-proyecto-cypress/cypress/report',
        reportFiles: 'index.html',
        reportName: 'Reporte Cypress',
        keepAll: true,
        alwaysLinkToLastBuild: true,
        allowMissing: false
      ])
    }
  }
}
