pipeline {
  agent any

  tools {
    nodejs "NodeJS 25"
  }

  parameters {
    string(
      name: 'TEST_SPEC',
      defaultValue: 'cypress/e2e/**/*.cy.js',
      description: 'Ruta del test o tests a ejecutar'
    )
  }

  stages {

    stage('Instalar dependencias') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Instalando dependencias ==="
              npm ci

              Write-Host "=== Instalando reporter JUnit seguro ==="
              npm install --save-dev cypress-junit-reporter

              Write-Host "=== Dependencias instaladas ==="
            '''
          }
        }
      }
    }

    stage('Ejecutar pruebas Cypress') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {
          dir('mi-proyecto-cypress') {
            powershell '''
              Write-Host "=== Ejecutando pruebas Cypress ==="

              npx cypress run --spec "$env:TEST_SPEC" `
                --reporter cypress-junit-reporter `
                --reporter-options "mochaFile=cypress/results/results-[hash].xml"

              $code = $LASTEXITCODE
              Write-Host "Cypress terminó con código: $code"

              exit 0
            '''
          }
        }
      }
    }

    stage('Validar XMLs JUnit') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Validando XMLs generados ==="

            $xmlFiles = Get-ChildItem "cypress/results" -Include *.xml -ErrorAction SilentlyContinue

            foreach ($file in $xmlFiles) {
              try {
                [xml]$doc = Get-Content $file.FullName
                Write-Host "✔ XML válido: $($file.Name)"
              } catch {
                Write-Host "❌ XML inválido: $($file.Name)"
                Write-Host "Intentando limpieza básica..."

                # Limpieza simple: eliminar caracteres no imprimibles
                $content = Get-Content $file.FullName -Raw
                $clean = ($content.ToCharArray() | Where-Object {
                  $code = [int]$_
                  $code -ge 32 -or $code -eq 10 -or $code -eq 13
                }) -join ''

                $clean | Set-Content $file.FullName

                try {
                  [xml]$doc2 = Get-Content $file.FullName
                  Write-Host "✔ XML reparado correctamente"
                } catch {
                  Write-Host "❌ No se pudo reparar el XML"
                }
              }
            }
          '''
        }
      }
    }

    stage('Preparar historial Allure') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Copiando historial de Allure (si existe) ==="

            if (Test-Path "allure-report/history") {
              Copy-Item -Recurse -Force "allure-report/history" "allure-results/history"
            } else {
              Write-Host "No existe historial previo."
            }
          '''
        }
      }
    }

    stage('Backup de videos y screenshots por fecha (versión A)') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Preparando backup por fecha ==="

            $dateFolder = (Get-Date -Format "yyyy-MM-dd")

            if (!(Test-Path "videos_backup")) { New-Item -ItemType Directory -Path "videos_backup" | Out-Null }
            if (!(Test-Path "screenshots_backup")) { New-Item -ItemType Directory -Path "screenshots_backup" | Out-Null }

            $videosDatePath = Join-Path "videos_backup" $dateFolder
            $screensDatePath = Join-Path "screenshots_backup" $dateFolder

            if (!(Test-Path $videosDatePath)) { New-Item -ItemType Directory -Path $videosDatePath | Out-Null }
            if (!(Test-Path $screensDatePath)) { New-Item -ItemType Directory -Path $screensDatePath | Out-Null }

            Write-Host "=== Copiando SOLO videos raíz ==="
            Get-ChildItem "cypress/videos" -File -Include *.mp4 -ErrorAction SilentlyContinue |
              ForEach-Object {
                $dest = Join-Path $videosDatePath $_.Name
                Copy-Item $_.FullName -Destination $dest -Force -ErrorAction SilentlyContinue
              }

            Write-Host "=== Copiando screenshots (recursivo) ==="
            Get-ChildItem -Recurse "cypress/screenshots" -Include *.png -ErrorAction SilentlyContinue |
              ForEach-Object {
                $dest = Join-Path $screensDatePath $_.Name
                Copy-Item $_.FullName -Destination $dest -Force -ErrorAction SilentlyContinue
              }

            Write-Host "=== Backup por fecha completado ==="
          '''
        }
      }
    }

    stage('Diagnóstico de artefactos') {
      steps {
        dir('mi-proyecto-cypress') {
          powershell '''
            Write-Host "=== Diagnóstico de artefactos ==="

            Write-Host "--- Videos Backup ---"
            Get-ChildItem -Recurse videos_backup -ErrorAction SilentlyContinue

            Write-Host "--- Screenshots Backup ---"
            Get-ChildItem -Recurse screenshots_backup -ErrorAction SilentlyContinue

            Write-Host "--- Mochawesome Report ---"
            Get-ChildItem -Recurse cypress/report -ErrorAction SilentlyContinue

            Write-Host "--- Allure Results ---"
            Get-ChildItem -Recurse allure-results -ErrorAction SilentlyContinue

            Write-Host "--- Allure Report (HTML) ---"
            Get-ChildItem -Recurse allure-report -ErrorAction SilentlyContinue
          '''
        }
      }
    }

    stage('Publicar Mochawesome') {
      steps {
        publishHTML(target: [
          reportDir: 'mi-proyecto-cypress/cypress/report',
          reportFiles: 'index.html',
          reportName: 'Reporte Mochawesome',
          keepAll: true,
          alwaysLinkToLastBuild: true,
          allowMissing: true
        ])
      }
    }
  }

  post {
    always {
      echo '=== Archivando artefactos ==='

      archiveArtifacts artifacts: 'mi-proyecto-cypress/cypress/report/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/videos_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/screenshots_backup/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-results/**', allowEmptyArchive: true
      archiveArtifacts artifacts: 'mi-proyecto-cypress/allure-report/**', allowEmptyArchive: true

      powershell '''
        Write-Host "=== XMLs detectados antes de JUnit ==="
        Get-ChildItem -Recurse "mi-proyecto-cypress/cypress/results/*.xml" -ErrorAction SilentlyContinue
      '''

      junit testResults: 'mi-proyecto-cypress/cypress/results/*.xml', allowEmptyResults: true, keepLongStdio: true

      allure includeProperties: false, jdk: '', results: [[path: 'mi-proyecto-cypress/allure-results']]
    }
  }
}
